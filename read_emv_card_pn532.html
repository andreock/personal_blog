<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		
		<link href="./_app/immutable/assets/theme.CD54FDqW.css" rel="stylesheet">
		<link href="./_app/immutable/assets/0.CWaSuCoZ.css" rel="stylesheet">
		<link href="./_app/immutable/assets/BlogArticle.Cj3JevmP.css" rel="stylesheet">
		<link rel="modulepreload" href="./_app/immutable/entry/start.BMEsdMuc.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/CogkRpxI.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/DYMi3ZQW.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/JczOs3xW.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/CdvApJ5D.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/DzYx_OBU.js">
		<link rel="modulepreload" href="./_app/immutable/entry/app.CMi_6yWs.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/DsnmJJEf.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/D-ailMge.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/DdAMo6ks.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/CTt6hDyY.js">
		<link rel="modulepreload" href="./_app/immutable/nodes/0.fGFVAYu_.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/DIQQnP-l.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/B9ZA7XiK.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/Bhnz3hki.js">
		<link rel="modulepreload" href="./_app/immutable/nodes/3.B7Utkqd_.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/D_6joxXD.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/CdHX1ZD5.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/B51L_rOe.js"><!--[--><link rel="icon" href="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20width='107'%20height='128'%20viewBox='0%200%20107%20128'%3e%3ctitle%3esvelte-logo%3c/title%3e%3cpath%20d='M94.157%2022.819c-10.4-14.885-30.94-19.297-45.792-9.835L22.282%2029.608A29.92%2029.92%200%200%200%208.764%2049.65a31.5%2031.5%200%200%200%203.108%2020.231%2030%2030%200%200%200-4.477%2011.183%2031.9%2031.9%200%200%200%205.448%2024.116c10.402%2014.887%2030.942%2019.297%2045.791%209.835l26.083-16.624A29.92%2029.92%200%200%200%2098.235%2078.35a31.53%2031.53%200%200%200-3.105-20.232%2030%2030%200%200%200%204.474-11.182%2031.88%2031.88%200%200%200-5.447-24.116'%20style='fill:%23ff3e00'/%3e%3cpath%20d='M45.817%20106.582a20.72%2020.72%200%200%201-22.237-8.243%2019.17%2019.17%200%200%201-3.277-14.503%2018%2018%200%200%201%20.624-2.435l.49-1.498%201.337.981a33.6%2033.6%200%200%200%2010.203%205.098l.97.294-.09.968a5.85%205.85%200%200%200%201.052%203.878%206.24%206.24%200%200%200%206.695%202.485%205.8%205.8%200%200%200%201.603-.704L69.27%2076.28a5.43%205.43%200%200%200%202.45-3.631%205.8%205.8%200%200%200-.987-4.371%206.24%206.24%200%200%200-6.698-2.487%205.7%205.7%200%200%200-1.6.704l-9.953%206.345a19%2019%200%200%201-5.296%202.326%2020.72%2020.72%200%200%201-22.237-8.243%2019.17%2019.17%200%200%201-3.277-14.502%2017.99%2017.99%200%200%201%208.13-12.052l26.081-16.623a19%2019%200%200%201%205.3-2.329%2020.72%2020.72%200%200%201%2022.237%208.243%2019.17%2019.17%200%200%201%203.277%2014.503%2018%2018%200%200%201-.624%202.435l-.49%201.498-1.337-.98a33.6%2033.6%200%200%200-10.203-5.1l-.97-.294.09-.968a5.86%205.86%200%200%200-1.052-3.878%206.24%206.24%200%200%200-6.696-2.485%205.8%205.8%200%200%200-1.602.704L37.73%2051.72a5.42%205.42%200%200%200-2.449%203.63%205.79%205.79%200%200%200%20.986%204.372%206.24%206.24%200%200%200%206.698%202.486%205.8%205.8%200%200%200%201.602-.704l9.952-6.342a19%2019%200%200%201%205.295-2.328%2020.72%2020.72%200%200%201%2022.237%208.242%2019.17%2019.17%200%200%201%203.277%2014.503%2018%2018%200%200%201-8.13%2012.053l-26.081%2016.622a19%2019%200%200%201-5.3%202.328'%20style='fill:%23fff'/%3e%3c/svg%3e"/><!--]--><!--[--><link rel="stylesheet" href="./prism-atom-dark.css"/> <meta name="description" content="Explaining structure of EMV cards and how to read them using PN532 NFC module."/> <meta property="og:title" content="Read EMV with PN532"/> <meta property="og:description" content="Explaining structure of EMV cards and how to read them using PN532 NFC module."/> <meta property="og:image" content="https://andreock.github.io/personal_blog//emv_back.jpg"/><!--]--><title>Read EMV with PN532</title>
	</head>
	<body data-sveltekit-preload-data="hover">
		<div style="display: contents"><!--[--><!--[--><!----><div class="relative"><nav><div class="px-2 py-2.5 sm:px-4 sticky start-0 top-0 z-20 w-full"><div class="mx-auto flex flex-wrap items-center justify-between container"><a href="./" class="flex items-center"><img src="./icon.png" class="me-3 h-6 rounded-full sm:h-9" alt="Flowbite Logo"/> <span class="self-center text-xl font-semibold whitespace-nowrap dark:text-white">Andreock's blog</span><!----></a><!----> <!--[--><button type="button" class="focus:outline-hidden whitespace-normal focus:ring-gray-400 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-gray-50 m-0.5 rounded-lg focus:ring-2 p-1.5 dark:hover:bg-gray-700 ms-3 md:hidden" aria-label="Open main menu"><!--[--><span class="sr-only">Open main menu</span><!--]--> <svg xmlns="http://www.w3.org/2000/svg" role="button" tabindex="0" width="24" height="24" class="h-6 w-6 shrink-0" aria-label="bars 3" fill="none" viewBox="0 0 24 24" stroke-width="2"><!----><!----></svg><!----></button><!--]--><!----> <!--[!--><div class="w-full md:block md:w-auto hidden"><ul class="flex flex-col p-4 mt-0 rtl:space-x-reverse md:flex-row md:text-sm md:font-medium"><li><!--[!--><a href="./" class="block py-2 pe-4 ps-3 rounded-sm md:p-2 md:border-0"><!---->Home<!----></a><!--]--></li><!----></ul></div><!--]--><!----><!----><!----></div><!----></div></nav><!----> <div class="overflow-scroll"><!----><div class="min-h-screen overflow-x-hidden bg-gray-50 font-sans text-gray-900 svelte-ro9p46"><header><div class="mx-auto max-w-3xl px-4 py-6"><h1 class="text-3xl font-bold text-blue-700">Read EMV with PN532</h1> <img src="./emv_back.jpg" alt="Read EMV with PN532 image" class="mt-2 rounded-2xl md:h-100 md:w-full"/> <h3 class="mt-2 text-xl">Explaining structure of EMV cards and how to read them using PN532 NFC module.</h3></div></header><!----> <main class="mx-auto max-w-3xl px-4 pb-16"><article class="prose prose-lg prose-blue"><!----><p>In this article, we will explore how is structureted an EMV cards and how to read it using the PN532 NFC module.</p> <p>I tested the read of EMV using an Elechouse PN532 breakout board, other modules(also some cheap clone of Elechouse PN532) may not work due to poor antenna design.</p> <h2>EMV Card Structure</h2> <p>EMV(Europay, MasterCard and Visa) is a global standard for credit and debit payment cards based on chip card technology. Originally it uses the ISO/IEC 7816 standard for contact cards, but it has been extended to support also contactless cards using NFC technology ISO/IEC 14443.</p> <p>They are widely used for secure transactions in payment systems due to the usage of a chip that provides:</p> <ul><li>A whole OS that manages applications and data</li> <li>Cryptographic functions for secure authentication and data encryption</li> <li>Tamper-resistant hardware</li> <li>It can run Java applets called Java Card</li></ul> <p>It supports multiple applications on a single card, allowing for various payment methods and services to be integrated into one physical card.</p> <p>The structure of an EMV card is based on a hierarchical file system, which consists of the following components:</p> <ol><li><strong>Master File (MF)</strong>: The root directory of the card’s file system. It contains references to all other files and directories on the card. Usually is not read directly since it doesn’t contains useful data.</li> <li><strong>Dedicated Files (DF)</strong>: Subdirectories within the Master File that group related files together. Each DF can contain multiple Elementary Files (EF). These files are important to select the application on the card: it contains the PPSE(Payment System Environment) that returns the applications available on the card. It also return the ADF that contains the root of a specific application.</li> <li><strong>Elementary Files (EF)</strong>: The actual data files that store information such as card holder data, transaction history, and application data. It’s contained within Dedicated Files and the terminal needs to know the AFL(Application File Locator) associated to files to read them.</li></ol> <p>Every information stored on the EMV card is organized using <strong>Tag-Length-Value (TLV)</strong> encoding. Each data element is represented by a tag (identifier), length (size of the data), and value (actual data). TLV encoding allows for flexible and efficient storage and retrieval of data on the card.</p> <p>The communication with EMV cards is done using <strong>Application Protocol Data Units (APDUs)</strong>, which are standardized commands and responses defined by the ISO/IEC 7816 standard. APDUs are used to select files, read data, and perform various operations on the card.</p> <p>The APDU follow this structure:</p> <table><thead><tr><th>CLA</th><th>INS</th><th>P1</th><th>P2</th><th>Lc</th><th>Data</th><th>Le</th></tr></thead><tbody><tr><td>1 byte</td><td>1 byte</td><td>1 byte</td><td>1 byte</td><td>1 byte</td><td>variable length</td><td>1 byte</td></tr></tbody></table> <ul><li><strong>CLA</strong>: Class byte, indicates the type of command.</li> <li><strong>INS</strong>: Instruction byte, specifies the command to be executed.</li> <li><strong>P1 and P2</strong>: Parameter bytes, provide additional information for the command.</li> <li><strong>Lc</strong>: Length of the command data.</li> <li><strong>Data</strong>: Command data.</li> <li><strong>Le</strong>: Length of expected response data. 0 means maximum length.</li></ul> <h2>Patching Adafruit PN532 library</h2> <p>Firstly we need to patch the Adafruit PN532 library to add support for EMV commands. You can find the patched library <a href="https://github.com/andreock/Adafruit-PN532_Bruce/" rel="nofollow">here</a> but I will explain you the changes needed.</p> <p>The method that PN532 uses to communicate with ISO14443A cards is <code>inDataExchange()</code>, but it support data exchange with listed tag and since EMV cannot be listed we need to send data to the first NFC tag in the PN532 field.</p> <p>The <code>inDataExchange()</code> method have the following structure:</p> <table><thead><tr><th>D4</th><th>40</th><th>Tg</th><th>DataOut</th></tr></thead></table> <ul><li><strong>D4</strong>: Start of frame for PN532</li> <li><strong>40</strong>: InDataExchange command code</li> <li><strong>Tg</strong>: Target (cards) to communicate with. 1 means the first card detected.</li> <li><strong>DataOut</strong>: The actual data to be sent to the card.</li></ul> <p>We need to modify the method to force the Tg parameter to 1, so that we can communicate with the first card detected.</p> <pre class="language-c"><!----><code class="language-c">pn532_packetbuffer<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x40</span><span class="token punctuation">;</span> <span class="token comment">// PN532_COMMAND_INDATAEXCHANGE;</span>
pn532_packetbuffer<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
pn532_packetbuffer<span class="token punctuation">[</span><span class="token number">2.</span><span class="token punctuation">.</span>n<span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">;</span>    <span class="token comment">// n can be up to 264 bytes(262 bytes of data)</span>

<span class="token comment">// Send the command and check for ack</span></code><!----></pre> <p>Now we must check the response from the card. The response from PN532 structure is as follows:</p> <table><thead><tr><th>D5</th><th>41</th><th>Status</th><th>DataIn</th></tr></thead></table> <ul><li><strong>D5</strong>: Start of frame for PN532 response</li> <li><strong>41</strong>: InDataExchange response code</li> <li><strong>Status</strong>: Status byte indicating success or error.</li> <li><strong>DataIn</strong>: The actual data received from the card.</li></ul> <p>The data from the EMV card have the following structure:</p> <table><thead><tr><th>Data</th><th>SW1</th><th>SW2</th></tr></thead></table> <ul><li><strong>Data</strong>: The actual data received from the card.</li> <li><strong>SW1 and SW2</strong>: Status words indicating the result of the command.</li></ul> <p>We need to find the 0x90 0x00 byte sequence to identify the end of the data received from the card. If this sequence is not found, it means that an error occurred.</p> <pre class="language-c"><!----><code class="language-c"><span class="token comment">// Check for PN532 status</span>
    <span class="token class-name">uint8_t</span> length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">240</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>pn532_packetbuffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0x90</span> <span class="token operator">&amp;&amp;</span> pn532_packetbuffer<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0x00</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Found finish"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      length<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    length <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token comment">// Other code from inDataExchange() method</span></code><!----></pre> <p>So we calculate the length of the data received by iterating through the response buffer until we find the 0x90 0x00 sequence. We then add 2 to the length to account for the SW1 and SW2 bytes.</p> <h2>Getting the application identifier</h2> <p>Before reading any data from an EMV card, it’s important to select the card to activate the application associated with the data that we wanna read. Generally there are only an application per card, but some cards can have multiple applications installed.</p> <p>An application is identified by its Application Identifier (AID), which is a unique identifier assigned to each application on the card. The AID is used to select the application and access its data. The AID also identify the card vendor, here’s a list of common AIDs for major card vendors:</p> <table><thead><tr><th>Card Vendor</th><th>AID (Hexadecimal)</th></tr></thead><tbody><tr><td>MasterCard</td><td>A0000000041010</td></tr><tr><td>U.S Maestro</td><td>A0000000042203</td></tr><tr><td>Maestro</td><td>A0000000043060</td></tr><tr><td>Cirrus</td><td>A0000000046000</td></tr><tr><td>MasterCard</td><td>A0000000049999</td></tr><tr><td>Visa</td><td>A0000000031010</td></tr><tr><td>Electron</td><td>A0000000032010</td></tr><tr><td>V-Pay</td><td>A0000000032020</td></tr><tr><td>Visa</td><td>A0000000033010</td></tr><tr><td>Visa</td><td>A0000000038010</td></tr><tr><td>Visa</td><td>A00000000980840</td></tr><tr><td>American Express</td><td>A00000002501</td></tr><tr><td>Discover</td><td>A0000001523010</td></tr><tr><td>JCB</td><td>A0000000651010</td></tr><tr><td>UnionPay</td><td>A000000333010101</td></tr></tbody></table> <p>To select an application we can access to the DF called <code>2pay.sys.ddf01</code> that contains the PSE(Payment System Environment) used to get the AID, the select instruction have the following structure:</p> <table><thead><tr><th>0x00</th><th>0xA4</th><th>0x04</th><th>0x00</th><th>LC</th><th>Data</th><th>0x00</th></tr></thead></table> <ul><li><strong>0x00</strong>: CLA byte, indicates the type of command(select).</li> <li><strong>0xA4</strong>: INS byte, specifies the SELECT command.</li> <li><strong>0x04</strong>: P1 parameter, indicates that we are selecting by name.</li> <li><strong>0x00</strong>: P2 parameter, indicates that we want to select the first occurrence.</li> <li><strong>LC</strong>: Length of the data field.</li> <li><strong>Data</strong>: The name of the file to be selected(<code>2pay.sys.ddf01</code> in ASCII).</li> <li><strong>0x00</strong>: Le byte, indicates that we want to receive the maximum length of the response.</li></ul> <p>Every SELECT command return an <strong>FCI (File Control Information)</strong> that contains information about the selected file.</p> <pre class="language-c"><!----><code class="language-c"><span class="token comment">// Use BerTlv library: https://github.com/huckor/BER-TLV.git</span>
std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token class-name">uint8_t</span><span class="token operator">></span> EMVReader<span class="token operator">::</span><span class="token function">emv_ask_for_aid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">uint8_t</span> uid<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> len<span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> response<span class="token punctuation">[</span><span class="token number">240</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> response_len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token class-name">uint8_t</span><span class="token operator">></span> aid<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nfc<span class="token operator">-></span><span class="token function">readPassiveTargetID</span><span class="token punctuation">(</span>PN532_MIFARE_ISO14443A<span class="token punctuation">,</span> uid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// Poll for a ISO14443A card</span>
        <span class="token class-name">uint8_t</span> ask_for_aid_apdu<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xA4</span><span class="token punctuation">,</span> <span class="token number">0x04</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x0e</span><span class="token punctuation">,</span> 
                      <span class="token comment">//              2       p     a     y    .    s       y     s     .     d     d     f     0    1</span>
                                      <span class="token number">0x32</span><span class="token punctuation">,</span> <span class="token number">0x50</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">,</span> <span class="token number">0x59</span><span class="token punctuation">,</span> <span class="token number">0x2e</span><span class="token punctuation">,</span> <span class="token number">0x53</span><span class="token punctuation">,</span> <span class="token number">0x59</span><span class="token punctuation">,</span> <span class="token number">0x53</span><span class="token punctuation">,</span> <span class="token number">0x2e</span><span class="token punctuation">,</span> <span class="token number">0x44</span><span class="token punctuation">,</span> <span class="token number">0x44</span><span class="token punctuation">,</span> <span class="token number">0x46</span><span class="token punctuation">,</span> <span class="token number">0x30</span><span class="token punctuation">,</span> <span class="token number">0x31</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nfc<span class="token operator">-></span><span class="token function">EMVinDataExchange</span><span class="token punctuation">(</span>ask_for_aid_apdu<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ask_for_aid_apdu<span class="token punctuation">)</span><span class="token punctuation">,</span> response<span class="token punctuation">,</span> <span class="token operator">&amp;</span>response_len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token class-name">uint8_t</span><span class="token operator">></span> <span class="token function">response_vector</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>response<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>response<span class="token punctuation">[</span>response_len<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            BerTlv Tlv<span class="token punctuation">;</span>
            Tlv<span class="token punctuation">.</span><span class="token function">SetTlv</span><span class="token punctuation">(</span>response_vector<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>Tlv<span class="token punctuation">.</span><span class="token function">GetValue</span><span class="token punctuation">(</span><span class="token string">"4F"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>aid<span class="token punctuation">)</span> <span class="token operator">!=</span> OK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// Application ID</span>
                Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Can't get aid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                aid<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Get AID successfully"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> aid<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code><!----></pre> <p>With the AID we can navigate through the file system associated to that application and read the data stored on the card. AID is contained in the tag <code>4F</code> of the response. You can decode the BerTLV response from card using <a href="https://emvlab.org/tlvutils/" rel="nofollow">TLV parser by emvlab.org</a>.</p> <h2>Selecting the application</h2> <p>Now, in order to access to the data associated to the application, we need to select it using the AID obtained in the previous step. This will give us access to the Application File Locator(AFL) that identify the files associated to that application.</p> <p>This can be done by sending a SELECT command to the card with the AID as parameter. The SELECT command have the same structure as before, but now we use the AID obtained previously as file identifier.</p> <pre class="language-c"><!----><code class="language-c">std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token class-name">uint8_t</span><span class="token operator">></span> EMVReader<span class="token operator">::</span><span class="token function">emv_ask_for_pdol</span><span class="token punctuation">(</span>std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token class-name">uint8_t</span><span class="token operator">></span> <span class="token operator">*</span>aid<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">uint8_t</span> uid<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> len<span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> response<span class="token punctuation">[</span><span class="token number">240</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> response_len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token class-name">uint8_t</span><span class="token operator">></span> pdol<span class="token punctuation">;</span>
                                          <span class="token comment">/* P1, P2,   LC */</span>   <span class="token comment">/* --------------- AID -----------------*/</span>  <span class="token comment">/* Le */</span>
    <span class="token class-name">uint8_t</span> ask_for_pdol<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xa4</span><span class="token punctuation">,</span> <span class="token number">0x04</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x07</span><span class="token punctuation">,</span>    <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span>      <span class="token number">0x00</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>ask_for_pdol <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">,</span> aid<span class="token operator">-></span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>nfc<span class="token operator">-></span><span class="token function">EMVinDataExchange</span><span class="token punctuation">(</span>ask_for_pdol<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ask_for_pdol<span class="token punctuation">)</span><span class="token punctuation">,</span> response<span class="token punctuation">,</span> <span class="token operator">&amp;</span>response_len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token class-name">uint8_t</span><span class="token operator">></span> <span class="token function">response_vector</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>response<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>response<span class="token punctuation">[</span>response_len<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        BerTlv Tlv<span class="token punctuation">;</span>
        Tlv<span class="token punctuation">.</span><span class="token function">SetTlv</span><span class="token punctuation">(</span>response_vector<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Tlv<span class="token punctuation">.</span><span class="token function">GetValue</span><span class="token punctuation">(</span><span class="token string">"9F38"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pdol<span class="token punctuation">)</span> <span class="token operator">!=</span> OK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// PDOL(Some card doesn't have it)</span>
            Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Can't get PDOL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            pdol<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> pdol<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code><!----></pre> <p>As you can see, some card send a PDOL at tag <code>9F38</code> with the response, this is a list of data objects that the terminal must provide to the card in order to proceed with the transaction(in our case to read data). Example of data requested are: transaction amount, date, currency and other information. I will proceed without it since MasterCard, for example, doesn’t need it. [Here you can find the section for the PDOL(if you wanna read VISA card for example)](#Reading PDOL)</p> <p>If the card doesn’t send a PDOL, this call doesn’t give any useful information to us apart from activating the application that we wanna read.</p> <p>Example of a successfully call on a VISA card:</p> <p><img src="/personal_blog/emv_select.png" alt="Select"/></p> <h2>Getting the Application File Locator</h2> <p>To get the AFL, we need to send a GET PROCESSING OPTIONS command to the card. This command is used to retrieve the processing options for the selected application, including the AFL.</p> <p>This commands have CLA <code>0x80</code> and INS <code>0xA8</code>. The command field is structured as following:</p> <table><thead><tr><th>0x80</th><th>0xA8</th><th>0x00</th><th>0x00</th><th>LM</th><th>0x83</th><th>DL</th><th>Data</th><th>0x00</th></tr></thead></table> <ul><li><strong>LM</strong>: Length of the data field + 2(DL and Tag 0x83).</li> <li><strong>DL</strong>: Length of the data field.</li></ul> <pre class="language-c"><!----><code class="language-c">std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token class-name">uint8_t</span><span class="token operator">></span> EMVReader<span class="token operator">::</span><span class="token function">emv_get_processing_options_no_pdol</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">uint8_t</span> response<span class="token punctuation">[</span><span class="token number">240</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> response_len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token class-name">uint8_t</span><span class="token operator">></span> afl<span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> ask_for_afl<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token number">0x80</span><span class="token punctuation">,</span>  <span class="token comment">// CLA</span>
        <span class="token number">0xa8</span><span class="token punctuation">,</span>  <span class="token comment">// INS</span>
        <span class="token number">0x00</span><span class="token punctuation">,</span>  <span class="token comment">// P1: Fixed to </span>
        <span class="token number">0x00</span><span class="token punctuation">,</span>  <span class="token comment">// P2: Fixed to</span>
        <span class="token number">0x02</span><span class="token punctuation">,</span>  <span class="token comment">// Lc: Length of the data field + 2</span>
        <span class="token number">0x83</span><span class="token punctuation">,</span>  <span class="token comment">// Indicate that we are sending PDOL</span>
        <span class="token number">0x00</span><span class="token punctuation">,</span>  <span class="token comment">// Empty PDOL</span>
        <span class="token number">0x00</span>   <span class="token comment">// Le: Expected length of the response(send 0 to get maximum length)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// Get AFL</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>nfc<span class="token operator">-></span><span class="token function">EMVinDataExchange</span><span class="token punctuation">(</span>ask_for_afl<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ask_for_afl<span class="token punctuation">)</span><span class="token punctuation">,</span> response<span class="token punctuation">,</span> <span class="token operator">&amp;</span>response_len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token class-name">uint8_t</span><span class="token operator">></span> <span class="token function">response_vector</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>response<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>response<span class="token punctuation">[</span>response_len<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        BerTlv Tlv<span class="token punctuation">;</span>
        Tlv<span class="token punctuation">.</span><span class="token function">SetTlv</span><span class="token punctuation">(</span>response_vector<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Tlv<span class="token punctuation">.</span><span class="token function">GetValue</span><span class="token punctuation">(</span><span class="token string">"94"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>afl<span class="token punctuation">)</span> <span class="token operator">!=</span> OK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// AFL</span>
            Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Can't get AFL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            afl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> afl<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code><!----></pre> <p>If all goes well, you will receive a similar response parsed:</p> <p><img src="/personal_blog/gpo_response.png" alt="GET PROCESSION OPTIONS response"/></p> <p>Some observations:</p> <ul><li>Usually there are some junk bytes from PN532 that gives error during TLV parsing on website, you can ignore them since the C library doesn’t complain most of time.</li> <li>The AFL is contained in the tag <code>94</code>.</li> <li>The response can contain the tag <code>57</code> (Track 2 Equivalent Data) that contains card number and expiration date in the following format: <code>CARDNUMBER-DY-YM-M...</code>. <code>D</code> is the separator, <code>Y</code> is year and <code>M</code> is month. You can parse it with the following bitwise trick:</li></ul> <pre class="language-c"><!----><code class="language-c"><span class="token comment">// Index 9 is separator 'D' and first digit of ValidTo month</span>
<span class="token comment">// Index 10 is second digit of ValidTo month and first digit of ValidTo year</span>
<span class="token comment">// Index 11 is second digit of ValidTo year and first digit of Service Code</span>
card<span class="token operator">-></span>validto <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
card<span class="token operator">-></span>validto<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>container<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>container<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0xF0</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// Isolate year</span>
card<span class="token operator">-></span>validto<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>container<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>container<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0xF0</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// Isolate month</span></code><!----></pre> <p>In this case you will not need to read the EF that contains card number and expiration date but you can explore it to find other interesting data, if the card have any.</p> <h2>Read files using afl</h2> <p>Now that we have the AFL, we can read the files associated to the application. The AFL is a list of records that specify which files to read and how to read them. It is structured as follows:</p> <table><thead><tr><th>SFI</th><th>First Record</th><th>Last Record</th><th>Number of Records for auth</th></tr></thead></table> <ul><li><strong>SFI (Short File Identifier)</strong>: A unique identifier for the EF to be read.</li> <li><strong>First Record</strong>: The first record number to be read from the file.</li> <li><strong>Last Record</strong>: The last record number to be read from the file.</li> <li><strong>Number of Records for auth</strong>: The total number of records that the file provides for authentication purposes, usually a generated cryptogram, verified by the bank online, that will authenticate a transaction, there is also a field for offline authentication. These records are needed for transactions performed by a real terminal that can contact the bank to perform the payment.</li></ul> <p>In our code, we will iterate through the AFL and read each record specified searching for PAN and issue/expire data. The READ RECORD command have the following structure:</p> <table><thead><tr><th>0x00</th><th>0xB2</th><th>Record Number</th><th><code>(SFI &lt;&lt; 3)</code></th><th>0x00</th></tr></thead></table> <ul><li><strong>0x00</strong>: CLA byte, indicates the type of command(read).</li> <li><strong>0xB2</strong>: INS byte, specifies the READ RECORD command.</li> <li><strong>Record Number</strong>: The record number to be read.</li> <li><strong><code>(SFI &lt;&lt; 3)</code></strong>: The SFI shifted left by 3 bits.</li> <li><strong>0x00</strong>: Le byte, indicates that we want to receive the maximum length of the response.</li></ul> <p>The following code reads the AFL and extracts the PAN and validity dates from the records:</p> <pre class="language-c"><!----><code class="language-c"><span class="token keyword">void</span> EMVReader<span class="token operator">::</span><span class="token function">read_afl</span><span class="token punctuation">(</span>EMVCard <span class="token operator">*</span>card<span class="token punctuation">,</span> std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token class-name">uint8_t</span><span class="token operator">></span> <span class="token operator">*</span>afl<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> afl<span class="token operator">-></span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">uint8_t</span> sfi <span class="token operator">=</span> <span class="token punctuation">(</span>afl<span class="token operator">-></span><span class="token function">at</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Get SFI from AFL entry</span>
        <span class="token class-name">uint8_t</span> record_start <span class="token operator">=</span> afl<span class="token operator">-></span><span class="token function">at</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">uint8_t</span> record_end <span class="token operator">=</span> afl<span class="token operator">-></span><span class="token function">at</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token class-name">uint8_t</span><span class="token operator">></span> afl_content <span class="token operator">=</span> <span class="token function">emv_read_record</span><span class="token punctuation">(</span>record_start<span class="token punctuation">,</span> <span class="token punctuation">(</span>sfi <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0</span>b00000100<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>afl_content<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            BerTlv Tlv<span class="token punctuation">;</span>
            Tlv<span class="token punctuation">.</span><span class="token function">SetTlv</span><span class="token punctuation">(</span>afl_content<span class="token punctuation">)</span><span class="token punctuation">;</span>
            std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token class-name">uint8_t</span><span class="token operator">></span> container<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>Tlv<span class="token punctuation">.</span><span class="token function">GetValue</span><span class="token punctuation">(</span><span class="token string">"5A"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>container<span class="token punctuation">)</span> <span class="token operator">==</span> OK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// Get PAN(Credit Card Number).</span>
                card<span class="token operator">-></span>pan <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>container<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">memcpy</span><span class="token punctuation">(</span>card<span class="token operator">-></span>pan<span class="token punctuation">,</span> container<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> container<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Copy data from TLV to struct</span>
                card<span class="token operator">-></span>pan_len <span class="token operator">=</span> container<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                
                container<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                
                <span class="token keyword">if</span> <span class="token punctuation">(</span>Tlv<span class="token punctuation">.</span><span class="token function">GetValue</span><span class="token punctuation">(</span><span class="token string">"5F25"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>container<span class="token punctuation">)</span> <span class="token operator">==</span> OK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// Get ValidFrom date</span>
                    card<span class="token operator">-></span>validfrom <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// The format in card is YEAR/MONTH but I want MONTH/YEAR since is the standard format</span>
                    card<span class="token operator">-></span>validfrom<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> container<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                    card<span class="token operator">-></span>validfrom<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> container<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> 
                
                container<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                
                <span class="token keyword">if</span> <span class="token punctuation">(</span>Tlv<span class="token punctuation">.</span><span class="token function">GetValue</span><span class="token punctuation">(</span><span class="token string">"5F24"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>container<span class="token punctuation">)</span> <span class="token operator">==</span> OK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// Get ValidTo date</span>
                    card<span class="token operator">-></span>validfrom <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// The format in card is YEAR/MONTH but I want MONTH/YEAR since is the standard format</span>
                    card<span class="token operator">-></span>validfrom<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> container<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                    card<span class="token operator">-></span>validfrom<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> container<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// Exit after finding PAN</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Can't parse AFL data"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code><!----></pre> <ul><li>PAN will be contained in the tag <code>5A</code>.</li> <li>ValidFrom date will be contained in the tag <code>5F25</code>.</li> <li>ValidTo date will be contained in the tag <code>5F24</code>.</li> <li>They will be all in the same file.</li></ul> <h2>Reading PDOL</h2> <p>If this whole process seemed complicated to you (and it is), wait until you see the reading with the PDOL :)</p> <p>If the card provides a PDOL in the SELECT response, we need to provide the requested data in order to proceed with the transaction. The PDOL is a list of data objects that the terminal must provide to the card. An example of PDOL is:</p> <pre class="language-c"><!----><code class="language-c"><span class="token keyword">const</span> <span class="token class-name">uint8_t</span> pdol_example<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token number">0x9F</span><span class="token punctuation">,</span> <span class="token number">0x66</span><span class="token punctuation">,</span> <span class="token number">0x04</span><span class="token punctuation">,</span> <span class="token comment">// Terminal Transaction Qualifiers (4 bytes)</span>
  <span class="token number">0x9F</span><span class="token punctuation">,</span> <span class="token number">0x02</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token comment">// Amount, Authorized (6 bytes)</span>
  <span class="token number">0x9F</span><span class="token punctuation">,</span> <span class="token number">0x03</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token comment">// Amount, Other (6 bytes)</span>
  <span class="token number">0x9F</span><span class="token punctuation">,</span> <span class="token number">0x1A</span><span class="token punctuation">,</span> <span class="token number">0x02</span><span class="token punctuation">,</span> <span class="token comment">// Terminal Country Code (2 bytes)</span>
  <span class="token number">0x95</span><span class="token punctuation">,</span> <span class="token number">0x05</span><span class="token punctuation">,</span>       <span class="token comment">// Terminal Verification Results (5 bytes)</span>
  <span class="token number">0x5F</span><span class="token punctuation">,</span> <span class="token number">0x2A</span><span class="token punctuation">,</span> <span class="token number">0x02</span><span class="token punctuation">,</span> <span class="token comment">// Transaction Currency Code (2 bytes)</span>
  <span class="token number">0x9A</span><span class="token punctuation">,</span> <span class="token number">0x03</span><span class="token punctuation">,</span>       <span class="token comment">// Transaction Date (3 bytes)</span>
  <span class="token number">0x9C</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span>       <span class="token comment">// Transaction Type (1 byte)</span>
  <span class="token number">0x9F</span><span class="token punctuation">,</span> <span class="token number">0x37</span><span class="token punctuation">,</span> <span class="token number">0x04</span>  <span class="token comment">// Unpredictable Number (4 bytes)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code><!----></pre> <p>A PDOL data entry is structured as follows:</p> <table><thead><tr><th>Tag</th><th>Length</th></tr></thead></table> <ul><li><strong>Terminal Transaction Qualifiers (9F66)</strong>: Indicates the capabilities of the terminal. For VISA I found that the value <code>0x200000</code> works fine.</li> <li><strong>Amount, Authorized (9F02)</strong>: The amount authorized for the transaction. It’s not important, you can set it to <code>0x0000000000</code>.</li> <li><strong>Amount, Other (9F03)</strong>: The amount for other purposes. Same as before, set it to <code>0x0000000000</code>.</li> <li><strong>Terminal Country Code (9F1A)</strong>: The numeric country code of the terminal. You can find a list of country codes <a href="https://en.wikipedia.org/wiki/List_of_ISO_3166_country_codes" rel="nofollow">here</a>. For example for Italy is <code>380</code> so in hex is <code>0x0380</code>.</li> <li><strong>Terminal Verification Results (95)</strong>: Results of terminal verification checks. Set it to <code>0x0000000000</code> to indicate a success.</li> <li><strong>Transaction Currency Code (5F2A)</strong>: The currency code for the transaction. You can find a list <a href="https://en.wikipedia.org/wiki/ISO_4217#List_of_ISO_4217_currency_codes" rel="nofollow">here</a> For Euro is <code>978</code>, so in hex is <code>0x0978</code>.</li> <li><strong>Transaction Date (9A)</strong>: The date of the transaction. <code>0xdaymonthyear</code>, for example 2th Dicember 2025 is <code>0x021225</code>.</li> <li><strong>Transaction Type (9C)</strong>: The type of transaction being performed. Set it to <code>0x00</code> for a purchase.</li> <li><strong>Unpredictable Number (9F37)</strong>: A random number generated by the terminal. You can use any random value.</li></ul> <p>With all this information we can create the whole ADPU GET PROCESSING OPTIONS to send to the card:</p> <pre class="language-c"><!----><code class="language-c"><span class="token class-name">uint8_t</span> payload<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// --- HEADER ---</span>
    <span class="token number">0x80</span><span class="token punctuation">,</span>
    <span class="token number">0xA8</span><span class="token punctuation">,</span>
    <span class="token number">0x00</span><span class="token punctuation">,</span>
    <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token comment">// CLA, INS, P1, P2</span>

    <span class="token number">0x23</span><span class="token punctuation">,</span> <span class="token comment">// Len: 35 bytes (0x23 Hex)</span>

    <span class="token comment">// --- DATA FIELD ---</span>
    <span class="token number">0x83</span><span class="token punctuation">,</span>
    <span class="token number">0x21</span><span class="token punctuation">,</span> <span class="token comment">// Payload len</span>

    <span class="token comment">// Payload</span>
    <span class="token number">0x20</span><span class="token punctuation">,</span>
    <span class="token number">0x00</span><span class="token punctuation">,</span>
    <span class="token number">0x00</span><span class="token punctuation">,</span>
    <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token comment">// 9F66 (TTQ - Visa Standard)</span>
    <span class="token number">0x00</span><span class="token punctuation">,</span>
    <span class="token number">0x00</span><span class="token punctuation">,</span>
    <span class="token number">0x00</span><span class="token punctuation">,</span>
    <span class="token number">0x00</span><span class="token punctuation">,</span>
    <span class="token number">0x00</span><span class="token punctuation">,</span>
    <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token comment">// 9F02 (Amount 0)</span>
    <span class="token number">0x00</span><span class="token punctuation">,</span>
    <span class="token number">0x00</span><span class="token punctuation">,</span>
    <span class="token number">0x00</span><span class="token punctuation">,</span>
    <span class="token number">0x00</span><span class="token punctuation">,</span>
    <span class="token number">0x00</span><span class="token punctuation">,</span>
    <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token comment">// 9F03 (Amount Other 0)</span>
    <span class="token number">0x03</span><span class="token punctuation">,</span>
    <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token comment">// 9F1A (Country: Italy)</span>
    <span class="token number">0x00</span><span class="token punctuation">,</span>
    <span class="token number">0x00</span><span class="token punctuation">,</span>
    <span class="token number">0x00</span><span class="token punctuation">,</span>
    <span class="token number">0x00</span><span class="token punctuation">,</span>
    <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token comment">// 95   (TVR: No errors)</span>
    <span class="token number">0x09</span><span class="token punctuation">,</span>
    <span class="token number">0x78</span><span class="token punctuation">,</span> <span class="token comment">// 5F2A (Currency: Euro)</span>
    <span class="token number">0x25</span><span class="token punctuation">,</span>
    <span class="token number">0x11</span><span class="token punctuation">,</span>
    <span class="token number">0x25</span><span class="token punctuation">,</span> <span class="token comment">// 9A   (Date: 25 Nov 25)</span>
    <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token comment">// 9C   (Tx Type: Purchase)</span>
    <span class="token number">0x12</span><span class="token punctuation">,</span>
    <span class="token number">0x34</span><span class="token punctuation">,</span>
    <span class="token number">0x56</span><span class="token punctuation">,</span>
    <span class="token number">0x78</span><span class="token punctuation">,</span> <span class="token comment">// 9F37 (Unpredictable Num)</span>

    <span class="token number">0x00</span> <span class="token comment">// Len of response expected by the card(0 means all)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code><!----></pre> <p>You can now use this payload to send the GET PROCESSING OPTIONS command to the card, just like we did before without PDOL.</p> <p>This will allow you to read the AFL and proceed with reading the files as we did before. Sometimes the card will return also the Track 2 Equivalent Data at tag <code>57</code> that contains card number and expiration date.</p> <h2>Conclusion</h2> <p>I hope you enjoyed this article. Reading EMV cards can be a complex task due to the various commands and data structures involved but I found it really interesting to explore how they work under the hood. If you have any questions or want to share your experience with EMV cards, feel free to leave a comment in the Github discussion section of the blog!</p> <h3>References</h3> <ul><li>Claude Sonnet 4.5 for most information about EMV structure and commands.</li> <li><a href="https://werner.rothschopf.net/201703_arduino_esp8266_nfc.htm" rel="nofollow">Werner Rothschopf article about EMV and PN532</a>. It was the first article that I found about EMV and PN532, really good starting point besides it doesn’t explain well all the part of EMV specification.</li> <li><a href="https://www.openscdp.org/scripts/tutorial/emv/reademv.html" rel="nofollow">OpenSCDP</a> To improve the definition of EMV structure and commands.</li></ul><!----></article></main></div><!----><!----></div></div><!----><!--]--> <!--[!--><!--]--><!--]-->
			
			<script>
				{
					__sveltekit_jf5zm8 = {
						base: new URL(".", location).pathname.slice(0, -1),
						assets: "/personal_blog"
					};

					const element = document.currentScript.parentElement;

					Promise.all([
						import("./_app/immutable/entry/start.BMEsdMuc.js"),
						import("./_app/immutable/entry/app.CMi_6yWs.js")
					]).then(([kit, app]) => {
						kit.start(app, element, {
							node_ids: [0, 3],
							data: [null,null],
							form: null,
							error: null
						});
					});
				}
			</script>
		</div>
	</body>
</html>
