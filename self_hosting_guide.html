<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		
		<link href="./_app/immutable/assets/theme.CD54FDqW.css" rel="stylesheet">
		<link href="./_app/immutable/assets/0.D42SHAqd.css" rel="stylesheet">
		<link href="./_app/immutable/assets/3.BIx75axd.css" rel="stylesheet">
		<link rel="modulepreload" href="./_app/immutable/entry/start.kbsSaK3P.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/HpsVmfN4.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/BS-WmLDm.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/BErm-MzH.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/DyHCmPau.js">
		<link rel="modulepreload" href="./_app/immutable/entry/app.CUdaUfCF.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/DsnmJJEf.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/CFmRV1DA.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/DZm79Sgj.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/DmgZT4If.js">
		<link rel="modulepreload" href="./_app/immutable/nodes/0.Be12Ugah.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/B4wdVWwy.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/tj_-I7EG.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/8SDEx_rN.js">
		<link rel="modulepreload" href="./_app/immutable/nodes/3.uirzY7wL.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/B6BhZQCa.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/QsjHIwgP.js"><!--[--><link rel="icon" href="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20width='107'%20height='128'%20viewBox='0%200%20107%20128'%3e%3ctitle%3esvelte-logo%3c/title%3e%3cpath%20d='M94.157%2022.819c-10.4-14.885-30.94-19.297-45.792-9.835L22.282%2029.608A29.92%2029.92%200%200%200%208.764%2049.65a31.5%2031.5%200%200%200%203.108%2020.231%2030%2030%200%200%200-4.477%2011.183%2031.9%2031.9%200%200%200%205.448%2024.116c10.402%2014.887%2030.942%2019.297%2045.791%209.835l26.083-16.624A29.92%2029.92%200%200%200%2098.235%2078.35a31.53%2031.53%200%200%200-3.105-20.232%2030%2030%200%200%200%204.474-11.182%2031.88%2031.88%200%200%200-5.447-24.116'%20style='fill:%23ff3e00'/%3e%3cpath%20d='M45.817%20106.582a20.72%2020.72%200%200%201-22.237-8.243%2019.17%2019.17%200%200%201-3.277-14.503%2018%2018%200%200%201%20.624-2.435l.49-1.498%201.337.981a33.6%2033.6%200%200%200%2010.203%205.098l.97.294-.09.968a5.85%205.85%200%200%200%201.052%203.878%206.24%206.24%200%200%200%206.695%202.485%205.8%205.8%200%200%200%201.603-.704L69.27%2076.28a5.43%205.43%200%200%200%202.45-3.631%205.8%205.8%200%200%200-.987-4.371%206.24%206.24%200%200%200-6.698-2.487%205.7%205.7%200%200%200-1.6.704l-9.953%206.345a19%2019%200%200%201-5.296%202.326%2020.72%2020.72%200%200%201-22.237-8.243%2019.17%2019.17%200%200%201-3.277-14.502%2017.99%2017.99%200%200%201%208.13-12.052l26.081-16.623a19%2019%200%200%201%205.3-2.329%2020.72%2020.72%200%200%201%2022.237%208.243%2019.17%2019.17%200%200%201%203.277%2014.503%2018%2018%200%200%201-.624%202.435l-.49%201.498-1.337-.98a33.6%2033.6%200%200%200-10.203-5.1l-.97-.294.09-.968a5.86%205.86%200%200%200-1.052-3.878%206.24%206.24%200%200%200-6.696-2.485%205.8%205.8%200%200%200-1.602.704L37.73%2051.72a5.42%205.42%200%200%200-2.449%203.63%205.79%205.79%200%200%200%20.986%204.372%206.24%206.24%200%200%200%206.698%202.486%205.8%205.8%200%200%200%201.602-.704l9.952-6.342a19%2019%200%200%201%205.295-2.328%2020.72%2020.72%200%200%201%2022.237%208.242%2019.17%2019.17%200%200%201%203.277%2014.503%2018%2018%200%200%201-8.13%2012.053l-26.081%2016.622a19%2019%200%200%201-5.3%202.328'%20style='fill:%23fff'/%3e%3c/svg%3e"/><!--]--><!--[--><link rel="stylesheet" href="./prism-atom-dark.css"/><!--]--><title>Self Hosting Journey</title>
	</head>
	<body data-sveltekit-preload-data="hover">
		<div style="display: contents"><!--[--><!--[--><!----><nav><div class="relative w-full px-2 py-2.5 sm:px-4"><div class="mx-auto flex flex-wrap items-center justify-between container"><a href="./" class="flex items-center"><img src="./icon.png" class="me-3 h-6 rounded-full sm:h-9" alt="Flowbite Logo"/> <span class="self-center text-xl font-semibold whitespace-nowrap dark:text-white">Andreock's blog</span><!----></a><!----> <!--[--><button type="button" class="focus:outline-hidden whitespace-normal focus:ring-gray-400 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-gray-50 m-0.5 rounded-lg focus:ring-2 p-1.5 dark:hover:bg-gray-700 ms-3 md:hidden" aria-label="Open main menu"><!--[--><span class="sr-only">Open main menu</span><!--]--> <svg xmlns="http://www.w3.org/2000/svg" role="button" tabindex="0" width="24" height="24" class="h-6 w-6 shrink-0" aria-label="bars 3" fill="none" viewBox="0 0 24 24" stroke-width="2"><!----><!----></svg><!----></button><!--]--><!----> <!--[!--><div class="w-full md:block md:w-auto hidden"><ul class="flex flex-col p-4 mt-0 rtl:space-x-reverse md:flex-row md:text-sm md:font-medium"><li><!--[!--><a href="./" class="block py-2 pe-4 ps-3 rounded-sm md:p-2 md:border-0"><!---->Home<!----></a><!--]--></li><!----></ul></div><!--]--><!----><!----><!----></div><!----></div></nav><!----> <!----><div class="min-h-screen bg-gray-50 font-sans text-gray-900"><header class="mb-8"><div class="mx-auto max-w-3xl px-4 py-6"><h1 class="text-3xl font-bold text-blue-700">Self Hosting Journey</h1> <img src="./nextcloud-gmbh-logo-vector.svg" alt="Self Hosting Journey image" class="h-60 w-full"/> <h3 class="mt-2 text-xl">A little story about my experience with self-hosting and some advices.</h3></div></header><!----> <main class="mx-auto max-w-3xl px-4 pb-16"><article class="prose prose-lg prose-blue"><!----><h2>Why?</h2> <p>I started with self-hosting about 5 years ago when I set up a personal cloud with my Raspberry PI 4, that includes Jellyfin and a simple file manager to share files between my devices.</p> <p>About 2 years ago I started to becoming aware of privacy problems of the various services I was using, so I started to look for alternatives and I found out that self-hosting could be a good solution for me.</p> <p>Self-hosting requires a lot of free time, especially during the first setup, but it gives you a lot of freedom and control over your data. After the first setup, the things usually goes more smoothly, but you have to be ready to face some problems and to spend some time to fix them(especially if you host your machine at home).</p> <p>This article requires knowledge about Linux administration, Docker and networking. If you are not familiar with these topics, I suggest you to make some pratice with simpler setup before trying to set up a complex server like the one in the article.</p> <h2>My setup</h2> <p>When I started with self-hosting, I thought that having hardware in my homelab could be a good idea but with the time I have several issues with hardware problems so I decided to move to a VPS.</p> <p>Actual setup:</p> <ul><li>VPS from <a href="https://contabo.com/" target="_blank" rel="noopener noreferrer"><!---->Contabo<!----></a><!----> with 3vCPUs core(6 threads), 8GB RAM, 400GB SSD and 300 Mbit/s connection with 32TB out and unlimited in. I use Debian 13 as OS but you can choose also Red Hat derivates or upload your ISO.</li> <li>Raspberry PI 4B with 2 1TB SSD BTRFS RAID 1 for VPS backup + my laptop backup</li></ul> <p>I think that VPS is a good solution to avoid hardware problems and stability issues. The price is acceptable in my opinion, about 100 euro/year. Using a VPS require a bit more work to secure it properly, but it’s not a big deal.</p> <h2>Services</h2> <p>I actually host the following services:</p> <ul><li><a href="https://nextcloud.com/" target="_blank" rel="noopener noreferrer"><!---->Nextcloud<!----></a><!----> for file sharing, calendar, contacts and notes. It replaces entirely the Google Workspace except for Gmail(I use Proton Mail for that).</li> <li><a href="https://jellyfin.org/" target="_blank" rel="noopener noreferrer"><!---->Jellyfin<!----></a><!----> for media streaming. It replaces Spotify and Netflix(if you have some film/series to upload).</li> <li><a href="https://github.com/dani-garcia/vaultwarden" target="_blank" rel="noopener noreferrer"><!---->VaultWarden<!----></a><!----> for password management across every device. It's easier to set up than Bitwarden, and it requires less resources.</li> <li><a href="https://adguard.com/en/adguard-home/overview.html" target="_blank" rel="noopener noreferrer"><!---->AdGuard Home<!----></a><!----> for network-wide ad blocking and tracking protection.</li> <li><a href="https://nlnetlabs.nl/projects/unbound/about/" target="_blank" rel="noopener noreferrer"><!---->Unbound DNS<!----></a><!----> as DNS resolver to improve privacy and security. Using Unbound broke the dependency of DNS providers like Google, Cloudflare, ...</li> <li><a href="https://docs.openwebui.com/" target="_blank" rel="noopener noreferrer"><!---->Open WebUI<!----></a><!----> as my AI API client. I use <a href="https://openrouter.ai/" target="_blank" rel="noopener noreferrer"><!---->Open Router<!----></a><!----> as the pay-as-you-use payment model allows me to save money on expensive AI plan without any limit about the model choice. Furthermore, it acts like a proxy, so I'm not being tracker by the API provider(the context will still be leaked obviously).</li></ul> <p>All these services(except DNS that’s on Raspberry PI 4) are behind a wireguard VPN hosted on the VPS to improve security and privacy. You can also use Tailscale or other P2P VPN solutions if you don’t want to manage your own VPN server.</p> <p>Using a VPN permit us to avoid exposing services directly to the internet, reducing the attack surface. In case of VPS failure, Contabo gives an emergency console useful if SSH is unavailable.</p> <h2>Make data invisible to the provider</h2> <p>Most of the people that doesn’t approve the self-hosting on VPS, say that your data can be read by the VPS provider like Google or any other cloud company does.</p> <p>That’s forbidden by ToS of almost all VPS provider, except for legal reasons. If you still doesn’t rely on provider ToS, like me, you can make a LUKS encrypted disk for your data, OS will remain unencrypted but assuming that OS doesn’t have any backdoor, it’s safe.</p> <p>So as first step, boot your VPS in rescue mode and resize the ext4 filesystem:</p> <pre class="language-shell"><!----><code class="language-shell">e2fsck <span class="token parameter variable">-f</span> /dev/sdXn
resize2fs /dev/sdXn 20G</code><!----></pre> <ul><li>Run <code>fdisk /dev/sdX</code>, delete the existing OS partition and create a new one with 20GB of space for your OS formatted in the original filesystem. <strong>Don’t remove the ext4 signature</strong></li> <li>Create another partition with the remaining space and don’t format it.</li> <li>Save changes to disk</li> <li>Check the partition using <code>e2fsck -f /dev/sdXn</code></li></ul> <p>Where <code>/dev/sdXn</code> is the partition you created for your OS.</p> <p>Now reboot your VPS in normal mode and setup LUKS on the unformatted partition(assuming you are logged in as root, otherwise use <code>sudo cmd</code>):</p> <pre class="language-shell"><!----><code class="language-shell"><span class="token function">apt</span> update
<span class="token function">apt</span> upgrade <span class="token comment"># Upgrade the packages to avoid any security issue</span>
<span class="token function">apt</span> <span class="token function">install</span> cryptsetup
cryptsetup luksFormat /dev/sdXn
cryptsetup <span class="token function">open</span> /dev/sdXn my_encrypted_disk
mkfs.ext4 /dev/mapper/my_encrypted_disk  <span class="token comment"># you can use BTRFS if you want to use subvolume or snapshot features</span>
<span class="token function">mount</span> /dev/mapper/my_encrypted_disk /mnt</code><!----></pre> <p>Where <code>/dev/sdXn</code> is the partition you created for your data.</p> <p>Now you can mount partition and use it for your data. Remember to save the passphrase in a safe place, if you lose it, you will lose your data.</p> <p><strong>With the following setup your will need to unlock your device everytime the VPS reboot(usually any VPS with a good provider doesn’t have stability issues)</strong></p> <h2>Secure the VPS: Firewall and VPN</h2> <p>First of all, you have to secure your VPS. The first step is to set up a firewall, I use <code>ufw</code> as it’s easy to use and configure:</p> <pre class="language-shell"><!----><code class="language-shell"><span class="token function">apt</span> <span class="token function">install</span> ufw
ufw allow <span class="token function">ssh</span> <span class="token comment"># If you don't want to secure SSH with VPN</span>
ufw default deny incoming
ufw default allow outgoing</code><!----></pre> <p><strong>Don’t enable the firewall as it will break your SSH session</strong></p> <p>Now I will show the installation of Wireguard VPN, if you prefer an hosted solution like Tailscale, skip this section and jump to firewall setup.</p> <p>For the Wireguard setup I use the <a href="https://github.com/angristan/wireguard-install>wireguard-install" target="_blank" rel="noopener noreferrer"><!---->wireguard-install<!----></a><!----> script that automate the installation and configuration of Wireguard. If you want a GUI dashboard you can use <a href="https://github.com/donaldzou/WGDashboard" target="_blank" rel="noopener noreferrer"><!---->WGDashboard<!----></a><!---->.</p> <p>Run the script and follow the setup then add a user by running again the script after installation:</p> <pre class="language-shell"><!----><code class="language-shell"><span class="token function">apt</span> <span class="token function">install</span> <span class="token function">curl</span>
<span class="token function">curl</span> <span class="token parameter variable">-O</span> https://raw.githubusercontent.com/angristan/wireguard-install/master/wireguard-install.sh
<span class="token function">chmod</span> +x wireguard-install.sh
./wireguard-install.sh</code><!----></pre> <p><strong>Annotate the listen port of Wireguard</strong></p> <p>Transfer the generated config file to your device and import it in your Wireguard client.</p> <p>Try to ping the Wireguard interface IP of your VPS to check if the VPN is working.</p> <p>Now you can enable the firewall(run this step only if the VPN works as it will break your SSH connection):</p> <pre class="language-shell"><!----><code class="language-shell">ufw allow <span class="token operator">&lt;</span>WIREGUARD_PORT<span class="token operator">></span>/udp
ufw allow from any to <span class="token operator">&lt;</span>WIREGUARD_IP<span class="token operator">></span> port <span class="token number">22</span>  <span class="token comment"># Enable SSH from VPN only</span>
ufw allow <span class="token number">80</span> <span class="token comment"># Allow HTTP for certbot</span>
ufw <span class="token builtin class-name">enable</span></code><!----></pre> <p>Where <code>&lt;WIREGUARD_PORT></code> is the port you annotated before and <code>&lt;WIREGUARD_IP></code> is the Wireguard interface IP of your VPS(usually <code>wg0</code>).</p> <h2>Prepare the SSL certificate</h2> <p>For this step, I assume you have a domain name or a DDNS for configured on your VPS IP address.</p> <p>Nextcloud AIO and Vaultwarden requires an SSL certificate to work properly. You can use <a href="https://letsencrypt.org/" target="_blank" rel="noopener noreferrer"><!---->Let’s Encrypt<!----></a><!----> to get a free SSL certificate.</p> <p>Install certbot:</p> <pre class="language-shell"><!----><code class="language-shell"><span class="token function">apt</span> <span class="token function">install</span> certbot</code><!----></pre> <p>Now you can generate the SSL certificate:</p> <pre class="language-shell"><!----><code class="language-shell">certbot certonly <span class="token parameter variable">--standalone</span> --config-dir /mnt/nginx/ssl/config --work-dir /mnt/nginx/ssl --logs-dir /mnt/nginx/logs <span class="token parameter variable">-d</span> yourdomain.com </code><!----></pre> <h2>How I manage all this services?</h2> <p>Managing all this services can be painful if you don’t use a container based solution. In my case I use docker-compose as it’s easy to manage and configure. I wouldn’t recommend using more complex solution like Kubernetes as it introduce useless complexity and it’s really difficult to manage. If you want a GUI to manage the containers, <a href="https://docs.portainer.io/" target="_blank" rel="noopener noreferrer"><!---->Portainer CE<!----></a><!----> works well.</p> <p>Firstly install docker and docker-compose:</p> <pre class="language-shell"><!----><code class="language-shell"><span class="token function">apt</span> <span class="token function">install</span> docker.io <span class="token function">docker-compose</span>
systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> <span class="token function">docker</span></code><!----></pre> <p>Create the following <code>docker-compose.yaml</code> file under <code>$HOME/home_server/docker-compose.yml</code>:</p> <pre class="language-yaml"><!----><code class="language-yaml"><span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">nextcloud-aio-mastercontainer</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> ghcr.io/nextcloud<span class="token punctuation">-</span>releases/all<span class="token punctuation">-</span>in<span class="token punctuation">-</span>one<span class="token punctuation">:</span>latest
    <span class="token key atrule">init</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">network_mode</span><span class="token punctuation">:</span> bridge 
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> nextcloud<span class="token punctuation">-</span>aio<span class="token punctuation">-</span>mastercontainer <span class="token comment"># This line is not allowed to be changed as otherwise AIO will not work correctly</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> nextcloud_aio_mastercontainer<span class="token punctuation">:</span>/mnt/docker<span class="token punctuation">-</span>aio<span class="token punctuation">-</span>config <span class="token comment"># This line is not allowed to be changed as otherwise the built-in backup solution will not work</span>
      <span class="token punctuation">-</span> /var/run/docker.sock<span class="token punctuation">:</span>/var/run/docker.sock<span class="token punctuation">:</span>ro <span class="token comment"># May be changed on macOS, Windows or docker rootless. See the applicable documentation. If adjusting, don't forget to also set 'WATCHTOWER_DOCKER_SOCKET_PATH'!</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 8080<span class="token punctuation">:</span><span class="token number">8080</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span> 
      <span class="token key atrule">APACHE_PORT</span><span class="token punctuation">:</span> <span class="token number">11000</span>
      <span class="token key atrule">APACHE_IP_BINDING</span><span class="token punctuation">:</span> 127.0.0.1
      <span class="token key atrule">NEXTCLOUD_DATADIR</span><span class="token punctuation">:</span> /mnt/ncdata <span class="token comment"># ust this value after the initial Nextcloud installation is done! See https://github.com/nextcloud/all-in-one#how-to-change-the-default-location-of-nextclouds-datadir</span>
      <span class="token key atrule">NEXTCLOUD_MOUNT</span><span class="token punctuation">:</span> /mnt/ <span class="token comment"># Allows the Nextcloud container to access the chosen directory on the host. See https://github.com/nextcloud/all-in-one#how-to-allow-the-nextcloud-container-to-access-directories-on-the-host</span>
  
  <span class="token key atrule">vaultwarden</span><span class="token punctuation">:</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> vaultwarden
    <span class="token key atrule">image</span><span class="token punctuation">:</span> vaultwarden/server<span class="token punctuation">:</span>latest
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> unless<span class="token punctuation">-</span>stopped
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /mnt/bitwarden_data/<span class="token punctuation">:</span>/data/
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 12000<span class="token punctuation">:</span><span class="token number">80</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
<span class="token comment">#      SIGNUPS_ALLOWED: false # You can uncomment this after the first setup to disable new user registration</span>
      <span class="token key atrule">LOGIN_RATELIMIT_MAX_BURST</span><span class="token punctuation">:</span> <span class="token number">10</span>
      <span class="token key atrule">LOGIN_RATELIMIT_SECONDS</span><span class="token punctuation">:</span> <span class="token number">60</span>
  
  <span class="token key atrule">nginx</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>alpine
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> my_nginx
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> unless<span class="token punctuation">-</span>stopped
    <span class="token key atrule">network_mode</span><span class="token punctuation">:</span> host 
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /mnt/nginx/nginx.conf<span class="token punctuation">:</span>/etc/nginx/nginx.conf
      <span class="token punctuation">-</span> /mnt/nginx/conf.d/<span class="token punctuation">:</span>/etc/nginx/conf.d/
      <span class="token punctuation">-</span> /mnt/nginx/logs/<span class="token punctuation">:</span>/var/log/nginx
      <span class="token punctuation">-</span> /mnt/nginx/ssl<span class="token punctuation">:</span>/etc/ssl

  <span class="token key atrule">jellyfin</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> jellyfin/jellyfin
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> jellyfin
    <span class="token key atrule">network_mode</span><span class="token punctuation">:</span> <span class="token string">'host'</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /mnt/jellyfin_config<span class="token punctuation">:</span>/config
      <span class="token punctuation">-</span> /mnt/jellyfin_cache<span class="token punctuation">:</span>/cache
      <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> bind
        <span class="token key atrule">source</span><span class="token punctuation">:</span> /mnt/jellyfin
        <span class="token key atrule">target</span><span class="token punctuation">:</span> /media
      <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> bind
        <span class="token key atrule">source</span><span class="token punctuation">:</span> /mnt/fonts
        <span class="token key atrule">target</span><span class="token punctuation">:</span> /usr/local/share/fonts/custom
        <span class="token key atrule">read_only</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> <span class="token string">'unless-stopped'</span>
    <span class="token key atrule">extra_hosts</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">'host.docker.internal:host-gateway'</span>
  
  <span class="token key atrule">transmission</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> lscr.io/linuxserver/transmission<span class="token punctuation">:</span>latest
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> transmission
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> PUID=0
      <span class="token punctuation">-</span> PGID=0
      <span class="token punctuation">-</span> TZ=Etc/UTC
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /mnt/transmission<span class="token punctuation">:</span>/config
      <span class="token punctuation">-</span> /mnt/jellyfin<span class="token punctuation">:</span>/downloads <span class="token comment"># I use the same folder of jellyfin to have the downloaded files available in jellyfin. You can change it if you want</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 9091<span class="token punctuation">:</span><span class="token number">9091</span>
      <span class="token punctuation">-</span> 51413<span class="token punctuation">:</span><span class="token number">51413</span> <span class="token comment"># Default bittorrent port</span>
      <span class="token punctuation">-</span> 51413<span class="token punctuation">:</span>51413/udp
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> unless<span class="token punctuation">-</span>stopped

  <span class="token key atrule">openwebui</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> ghcr.io/open<span class="token punctuation">-</span>webui/open<span class="token punctuation">-</span>webui<span class="token punctuation">:</span>main
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"3001:8080"</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /mnt/open_webui<span class="token punctuation">:</span>/app/backend/data

<span class="token key atrule">volumes</span><span class="token punctuation">:</span> <span class="token comment"># If you want to store the data on a different drive, see https://github.com/nextcloud/all-in-one#how-to-store-the-filesinstallation-on-a-separate-drive</span>
  <span class="token key atrule">nextcloud_aio_mastercontainer</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> nextcloud_aio_mastercontainer
    <span class="token key atrule">driver</span><span class="token punctuation">:</span> local
    <span class="token key atrule">driver_opts</span><span class="token punctuation">:</span>
      <span class="token key atrule">type</span><span class="token punctuation">:</span> none
      <span class="token key atrule">device</span><span class="token punctuation">:</span> /mnt/nextcloud<span class="token punctuation">-</span>master
      <span class="token key atrule">o</span><span class="token punctuation">:</span> bind</code><!----></pre> <p>Now create the following <code>nginx.conf</code> file under <code>/mnt/nginx/nginx.conf</code>:</p> <pre class="language-nginx"><!----><code class="language-nginx"><span class="token directive"><span class="token keyword">user</span>  nginx</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">worker_processes</span>  auto</span><span class="token punctuation">;</span>

<span class="token directive"><span class="token keyword">error_log</span>  /var/log/nginx/error.log notice</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">pid</span>        /var/run/nginx.pid</span><span class="token punctuation">;</span>

<span class="token directive"><span class="token keyword">events</span></span> <span class="token punctuation">&#123;</span>
    <span class="token directive"><span class="token keyword">worker_connections</span>  <span class="token number">1024</span></span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token directive"><span class="token keyword">http</span></span> <span class="token punctuation">&#123;</span>
    <span class="token directive"><span class="token keyword">include</span>       /etc/nginx/mime.types</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">default_type</span>  application/octet-stream</span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">log_format</span>  main  <span class="token string">'<span class="token variable">$remote_addr</span> - <span class="token variable">$remote_user</span> [<span class="token variable">$time_local]</span> "<span class="token variable">$request</span>" '</span>
                      <span class="token string">'<span class="token variable">$status</span> <span class="token variable">$body_bytes_sent</span> "<span class="token variable">$http_referer</span>" '</span>
                      <span class="token string">'"<span class="token variable">$http_user_agent</span>" "<span class="token variable">$http_x_forwarded_for</span>"'</span></span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">access_log</span>  /var/log/nginx/access.log  main</span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">sendfile</span>        <span class="token boolean">on</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">keepalive_timeout</span>  <span class="token number">65</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">resolver</span> 127.0.0.11</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">include</span> /etc/nginx/conf.d/*.conf</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code><!----></pre> <p>Then create the necessary nginx folders:</p> <pre class="language-shell"><!----><code class="language-shell"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /mnt/nginx/ssl /mnt/nginx/ssl/config /mnt/nginx/logs /mnt/nginx/conf.d
<span class="token function">curl</span> <span class="token parameter variable">-L</span> https://ssl-config.mozilla.org/ffdhe2048.txt <span class="token parameter variable">-o</span> /mnt/nginx/ssl/dhparam</code><!----></pre> <h3>Configuring nginx for Nextcloud AIO</h3> <p>Create the following <code>nextcloud-aio.conf</code> file under <code>/mnt/nginx/conf.d/nextcloud-aio.conf</code>:</p> <pre class="language-nginx"><!----><code class="language-nginx"><span class="token directive"><span class="token keyword">map</span> <span class="token variable">$http_upgrade</span> <span class="token variable">$connection_upgrade</span></span> <span class="token punctuation">&#123;</span>
    <span class="token directive"><span class="token keyword">default</span> upgrade</span><span class="token punctuation">;</span>
    '' <span class="token directive"><span class="token keyword">close</span></span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">&#123;</span>
     <span class="token comment"># Don't use 80 as it's used by certbot</span>
     <span class="token comment"># Most of modern browsers automatically switch to HTTPS automatically</span>

     <span class="token directive"><span class="token keyword">listen</span> <span class="token number">443</span> ssl</span><span class="token punctuation">;</span>      <span class="token comment"># for nginx v1.25.1+</span>
     <span class="token directive"><span class="token keyword">listen</span> [::]:443 ssl</span><span class="token punctuation">;</span> <span class="token comment"># for nginx v1.25.1+ - keep comment to disable IPv6</span>
     <span class="token directive"><span class="token keyword">http2</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>            <span class="token comment"># uncomment to enable HTTP/2 - supported on nginx v1.25.1+</span>

    <span class="token directive"><span class="token keyword">http3</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>                                 <span class="token comment"># uncomment to enable HTTP/3 / QUIC - supported on nginx v1.25.0+</span>
    <span class="token directive"><span class="token keyword">quic_gso</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>                              <span class="token comment"># uncomment to enable HTTP/3 / QUIC - supported on nginx v1.25.0+</span>
    <span class="token directive"><span class="token keyword">quic_retry</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>                            <span class="token comment"># uncomment to enable HTTP/3 / QUIC - supported on nginx v1.25.0+</span>
    <span class="token directive"><span class="token keyword">add_header</span> Alt-Svc <span class="token string">'h3=":443"; ma=86400'</span></span><span class="token punctuation">;</span> <span class="token comment"># uncomment to enable HTTP/3 / QUIC - supported on nginx v1.25.0+</span>

    <span class="token directive"><span class="token keyword">proxy_buffering</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_request_buffering</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">client_max_body_size</span> <span class="token number">0</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">client_body_buffer_size</span> <span class="token number">512k</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">http3_stream_buffer_size</span> <span class="token number">512k</span></span><span class="token punctuation">;</span> <span class="token comment"># uncomment to enable HTTP/3 / QUIC - supported on nginx v1.25.0+</span>
    <span class="token directive"><span class="token keyword">proxy_read_timeout</span> <span class="token number">86400s</span></span><span class="token punctuation">;</span>
    
    <span class="token directive"><span class="token keyword">server_name</span> mydomain.com</span><span class="token punctuation">;</span> <span class="token comment"># Change to your domain</span>

    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">&#123;</span>
        <span class="token directive"><span class="token keyword">proxy_pass</span> http://127.0.0.1:11000<span class="token variable">$request_uri</span></span><span class="token punctuation">;</span> <span class="token comment"># Adjust to match APACHE_PORT and APACHE_IP_BINDING. See https://github.com/nextcloud/all-in-one/blob/main/reverse-proxy.md#adapting-the-sample-web-server-configurations-below</span>

        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-Port <span class="token variable">$server_port</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-Scheme <span class="token variable">$scheme</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-Proto <span class="token variable">$scheme</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Real-IP <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> Host <span class="token variable">$host</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> Early-Data <span class="token variable">$ssl_early_data</span></span><span class="token punctuation">;</span>

        <span class="token comment"># Websocket</span>
        <span class="token directive"><span class="token keyword">proxy_http_version</span> 1.1</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> Upgrade <span class="token variable">$http_upgrade</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> Connection <span class="token variable">$connection_upgrade</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token directive"><span class="token keyword">ssl_certificate</span> /etc/ssl/config/live/mydomain.com/fullchain.pem</span><span class="token punctuation">;</span>   <span class="token comment"># managed by certbot on host machine</span>
    <span class="token directive"><span class="token keyword">ssl_certificate_key</span> /etc/ssl/config/live/mydomain.com/privkey.pem</span><span class="token punctuation">;</span> <span class="token comment"># managed by certbot on host machine</span>

    <span class="token directive"><span class="token keyword">ssl_dhparam</span> /etc/ssl/dhparam</span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">ssl_early_data</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">ssl_session_timeout</span> <span class="token number">1d</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">ssl_session_cache</span> shared:SSL:10m</span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">ssl_protocols</span> TLSv1.2 TLSv1.3</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">ssl_ecdh_curve</span> x25519:x448:secp521r1:secp384r1:secp256r1</span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">ssl_prefer_server_ciphers</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">ssl_conf_command</span> Options PrioritizeChaCha</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">ssl_ciphers</span> TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-RSA-AES128-GCM-SHA256</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code><!----></pre> <p>This will configure nginx to proxy requests to Nextcloud AIO and handle SSL.</p> <p>This is necessary because Nextcloud and Vaultwarden will share the same certificate.</p> <h3>Configuring nginx for Vaultwarden</h3> <p>Create the following <code>vaultwarden.conf</code> file under <code>/mnt/nginx/conf.d/vaultwarden.conf</code>:</p> <pre class="language-nginx"><!----><code class="language-nginx"><span class="token directive"><span class="token keyword">map</span> <span class="token variable">$http_upgrade</span> <span class="token variable">$connection_upgrade</span></span> <span class="token punctuation">&#123;</span>
    <span class="token directive"><span class="token keyword">default</span> upgrade</span><span class="token punctuation">;</span>
    '' <span class="token directive"><span class="token keyword">close</span></span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">&#123;</span>
     <span class="token directive"><span class="token keyword">listen</span> <span class="token number">13000</span> ssl</span><span class="token punctuation">;</span>      <span class="token comment"># for nginx v1.25.1+</span>
     <span class="token directive"><span class="token keyword">listen</span> [::]:13000 ssl</span><span class="token punctuation">;</span> <span class="token comment"># for nginx v1.25.1+ - keep comment to disable IPv6</span>
     <span class="token directive"><span class="token keyword">http2</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>            <span class="token comment"># uncomment to enable HTTP/2 - supported on nginx v1.25.1+</span>

    <span class="token directive"><span class="token keyword">http3</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>                                 <span class="token comment"># uncomment to enable HTTP/3 / QUIC - supported on nginx v1.25.0+</span>
    <span class="token directive"><span class="token keyword">quic_gso</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>                              <span class="token comment"># uncomment to enable HTTP/3 / QUIC - supported on nginx v1.25.0+</span>
    <span class="token directive"><span class="token keyword">quic_retry</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>                            <span class="token comment"># uncomment to enable HTTP/3 / QUIC - supported on nginx v1.25.0+</span>
    <span class="token directive"><span class="token keyword">add_header</span> Alt-Svc <span class="token string">'h3=":443"; ma=86400'</span></span><span class="token punctuation">;</span> <span class="token comment"># uncomment to enable HTTP/3 / QUIC - supported on nginx v1.25.0+</span>

    <span class="token directive"><span class="token keyword">proxy_buffering</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_request_buffering</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">client_max_body_size</span> <span class="token number">0</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">client_body_buffer_size</span> <span class="token number">512k</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">http3_stream_buffer_size</span> <span class="token number">512k</span></span><span class="token punctuation">;</span> <span class="token comment"># uncomment to enable HTTP/3 / QUIC - supported on nginx v1.25.0+</span>
    <span class="token directive"><span class="token keyword">proxy_read_timeout</span> <span class="token number">86400s</span></span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">server_name</span> mydomain.com</span><span class="token punctuation">;</span> <span class="token comment"># Change to your domain</span>

    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">&#123;</span>
        <span class="token directive"><span class="token keyword">proxy_pass</span> http://127.0.0.1:12000<span class="token variable">$request_uri</span></span><span class="token punctuation">;</span> <span class="token comment"># Adjust to match APACHE_PORT and APACHE_IP_BINDING. See https://github.com/nextcloud/all-in-one/blob/main/reverse-proxy.md#adapting-the-sample-web-server-configurations-below</span>

        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-Port <span class="token variable">$server_port</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-Scheme <span class="token variable">$scheme</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-Proto <span class="token variable">$scheme</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Real-IP <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> Host <span class="token variable">$host</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> Early-Data <span class="token variable">$ssl_early_data</span></span><span class="token punctuation">;</span>

        <span class="token comment"># Websocket</span>
        <span class="token directive"><span class="token keyword">proxy_http_version</span> 1.1</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> Upgrade <span class="token variable">$http_upgrade</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> Connection <span class="token variable">$connection_upgrade</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token directive"><span class="token keyword">ssl_certificate</span> /etc/ssl/config/live/mydomain.com/fullchain.pem</span><span class="token punctuation">;</span>   <span class="token comment"># managed by certbot on host machine</span>
    <span class="token directive"><span class="token keyword">ssl_certificate_key</span> /etc/ssl/config/live/mydomain.com/privkey.pem</span><span class="token punctuation">;</span> <span class="token comment"># managed by certbot on host machine</span>

    <span class="token directive"><span class="token keyword">ssl_dhparam</span> /etc/ssl/dhparam</span><span class="token punctuation">;</span> <span class="token comment"># </span>

    <span class="token directive"><span class="token keyword">ssl_early_data</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">ssl_session_timeout</span> <span class="token number">1d</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">ssl_session_cache</span> shared:SSL:10m</span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">ssl_protocols</span> TLSv1.2 TLSv1.3</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">ssl_ecdh_curve</span> x25519:x448:secp521r1:secp384r1:secp256r1</span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">ssl_prefer_server_ciphers</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">ssl_conf_command</span> Options PrioritizeChaCha</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">ssl_ciphers</span> TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-RSA-AES128-GCM-SHA256</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code><!----></pre> <p>The other services doesn’t need a reverse proxy as they don’t strictly need SSL certificate as we are under VPN. If you still want to use nginx as reverse proxy for them, you can create similar configuration files changing the ports and the <code>proxy_pass</code> directive.</p> <p>Now you can set up the firewall and start the services by running:</p> <pre class="language-shell"><!----><code class="language-shell">ufw allow from any to <span class="token operator">&lt;</span>WIREGUARD_IP<span class="token operator">></span> port <span class="token number">13000</span>  <span class="token comment"># Allow vaultwarden on VPN</span>
ufw allow from any to <span class="token operator">&lt;</span>WIREGUARD_IP<span class="token operator">></span> port <span class="token number">443</span>  <span class="token comment"># Enable Nextcloud from VPN only</span>
ufw allow from any to <span class="token operator">&lt;</span>WIREGUARD_IP<span class="token operator">></span> port <span class="token number">8096</span>  <span class="token comment"># Enable Jellyfin from VPN only</span>
ufw allow from any to <span class="token operator">&lt;</span>WIREGUARD_IP<span class="token operator">></span> port <span class="token number">3001</span>  <span class="token comment"># Enable OpenWebUI from VPN only</span>
ufw allow from any to <span class="token operator">&lt;</span>WIREGUARD_IP<span class="token operator">></span> port <span class="token number">9091</span>  <span class="token comment"># Enable Transmission from VPN only</span>
<span class="token function">docker-compose</span> up <span class="token parameter variable">-d</span></code><!----></pre> <p>Now you will have the following services on the corresponding port:</p> <ul><li><code>8081</code>: Vaultwarden</li> <li><code>443</code>: Nextcloud</li> <li><code>8096</code>: Jellyfin</li> <li><code>3001</code>: OpenWebUI</li> <li><code>9091</code>: Transmission</li></ul> <p>You can set up each service by accessing to the corresponding port.</p> <p>Configuring each service is out of the scope of this article, but you can find a lot of tutorials online. I will just give you the path to use for the data of each service:</p> <ul><li>Nextcloud: No path required in the setup</li> <li>Vaultwarden: No path required in the setup</li> <li>Jellyfin: <code>/media</code> for media files</li> <li>OpenWebUI: No path required in the setup</li> <li>Transmission: <code>/downloads</code> for downloaded files. The files will be available in Jellyfin under <code>/media</code></li></ul> <p><strong>In order to use Nextcloud and Bitwarden you must set up DNS rewrite from <code>yourdomain.com</code> to your VPS DNS interface IP address in AdGuardHome, otherwise Nextcloud AIO will not work.</strong> This happens because Nextcloud AIO and Bitwarden needs a valid SSL certificate to work properly and accessing directly from VPS IP is not supported in HTTPS.</p> <h2>The DNS resolver</h2> <p>I use my Raspberry PI 4 as DNS resolver and ad-blocker because VPS introduces an important latency in the queries and you can’t host a DNS on a public IP so you would need to make a NAT masquerade to access DNS in your private home.</p> <p>To improve privacy and security, I use Unbound as DNS resolver. It will avoid using third party DNS providers like Google or Cloudflare that can log your queries. For the anti-tracking features, I use AdGuard Home.</p> <p>Firstly install Unbound on the Raspberry PI 4(or any other machine you want):</p> <pre class="language-shell"><!----><code class="language-shell"><span class="token function">apt</span> <span class="token function">install</span> unbound</code><!----></pre> <p>Create the following configuration file under <code>/etc/unbound/unbound.conf</code>:</p> <pre class="language-yaml"><!----><code class="language-yaml"><span class="token key atrule">include-toplevel</span><span class="token punctuation">:</span> <span class="token string">"/etc/unbound/unbound.conf.d/*.conf"</span>
<span class="token key atrule">server</span><span class="token punctuation">:</span>
    <span class="token comment">#logging</span>
    <span class="token comment"># verbosity number, 0 is least verbose. 1 is default.</span>
    <span class="token key atrule">verbosity</span><span class="token punctuation">:</span> <span class="token number">2</span>

    <span class="token comment">#log to stderr</span>
    <span class="token key atrule">use-syslog</span><span class="token punctuation">:</span> no
    <span class="token key atrule">logfile</span><span class="token punctuation">:</span> <span class="token string">""</span>

    <span class="token comment"># print UTC timestamp in ascii to logfile, default is epoch in seconds.</span>
    <span class="token key atrule">log-time-ascii</span><span class="token punctuation">:</span> yes

    <span class="token comment"># print one line with time, IP, name, type, class for every query.</span>
    <span class="token key atrule">log-queries</span><span class="token punctuation">:</span> yes

    <span class="token comment"># log with tag 'query' and 'reply' instead of 'info' for</span>
    <span class="token comment"># filtering log-queries and log-replies from the log.</span>
    <span class="token key atrule">log-tag-queryreply</span><span class="token punctuation">:</span> yes

    <span class="token comment">#binding interface and port</span>
    <span class="token comment"># specify the interfaces and port to answer queries from by ip-address.</span>
    <span class="token key atrule">interface</span><span class="token punctuation">:</span> 0.0.0.0
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5335</span>
    <span class="token comment"># control which clients are allowed to make (recursive) queries</span>
    <span class="token key atrule">access-control</span><span class="token punctuation">:</span> 127.0.0.0/8 allow

    <span class="token comment">#disable IPv6 if not needed</span>
    <span class="token key atrule">do-ip4</span><span class="token punctuation">:</span> yes
    <span class="token key atrule">do-udp</span><span class="token punctuation">:</span> yes
    <span class="token key atrule">do-tcp</span><span class="token punctuation">:</span> yes
    <span class="token key atrule">do-ip6</span><span class="token punctuation">:</span> no

    <span class="token comment">#hardening</span>
    <span class="token comment"># Harden against out of zone rrsets, to avoid spoofing attempts.</span>
    <span class="token key atrule">harden-glue</span><span class="token punctuation">:</span> yes

    <span class="token comment"># Harden against receiving dnssec-stripped data</span>
    <span class="token key atrule">harden-dnssec-stripped</span><span class="token punctuation">:</span> yes

    <span class="token comment"># Use 0x20-encoded random bits in the query to foil spoof attempts.</span>
    <span class="token key atrule">use-caps-for-id</span><span class="token punctuation">:</span> yes

    <span class="token comment"># enable to not answer id.server and hostname.bind queries.</span>
    <span class="token key atrule">hide-identity</span><span class="token punctuation">:</span> yes

    <span class="token comment"># enable to not answer version.server and version.bind queries.</span>
    <span class="token key atrule">hide-version</span><span class="token punctuation">:</span> yes

    <span class="token comment"># Sent minimum amount of information to upstream servers to enhance privacy.</span>
    <span class="token key atrule">qname-minimisation</span><span class="token punctuation">:</span> yes
    
    <span class="token comment"># Aggressive NSEC uses the DNSSEC NSEC chain to synthesize NXDOMAI</span>
    <span class="token key atrule">aggressive-nsec</span><span class="token punctuation">:</span> yes

    <span class="token comment"># If nonzero, unwanted replies are not only reported in statistics,</span>
    <span class="token comment"># but also a running total is kept per thread. If it reaches the</span>
    <span class="token comment"># threshold, a warning is printed and a defensive action is taken,</span>
    <span class="token comment"># the cache is cleared to flush potential poison out of it.</span>
    <span class="token comment"># A suggested value is 10000000, the default is 0 (turned off).</span>
    <span class="token key atrule">unwanted-reply-threshold</span><span class="token punctuation">:</span> <span class="token number">10000000</span>

    <span class="token comment">#efficency</span>
    <span class="token key atrule">prefetch</span><span class="token punctuation">:</span> yes

    <span class="token comment"># Serve expired responses from cache, with serve-expired-reply-ttl in</span>
    <span class="token comment"># the response, and then attempt to fetch the data afresh.</span>
    <span class="token key atrule">serve-expired</span><span class="token punctuation">:</span> yes
    
    <span class="token comment"># Limit serving of expired responses to configured seconds after</span>
    <span class="token comment"># expiration.</span>
    <span class="token key atrule">serve-expired-ttl</span><span class="token punctuation">:</span> <span class="token number">86400</span>

    <span class="token comment"># EDNS reassembly buffer to advertise to UDP peers (the actual buffer</span>
    <span class="token comment"># is set with msg-buffer-size).</span>
    <span class="token key atrule">edns-buffer-size</span><span class="token punctuation">:</span> <span class="token number">1232</span>

    <span class="token comment"># the time to live (TTL) value lower bound, in seconds. Default 0.</span>
    <span class="token comment"># If more than an hour could easily give trouble due to stale data.</span>
    <span class="token key atrule">cache-min-ttl</span><span class="token punctuation">:</span> <span class="token number">3600</span>

    <span class="token comment"># the time to live (TTL) value cap for RRsets and messages in the</span>
    <span class="token comment"># cache. Items are not cached for longer. In seconds.</span>
    <span class="token key atrule">cache-max-ttl</span><span class="token punctuation">:</span> <span class="token number">86400</span>

    <span class="token comment"># the amount of memory to use for the RRset cache.</span>
    <span class="token key atrule">rrset-cache-size</span><span class="token punctuation">:</span> 8m

    <span class="token comment"># the amount of memory to use for the message cache.</span>
    <span class="token key atrule">msg-cache-size</span><span class="token punctuation">:</span> 4m

    <span class="token comment"># number of threads to create. 1 disables threading.</span>
    <span class="token key atrule">num-threads</span><span class="token punctuation">:</span> <span class="token number">4</span>
    
    <span class="token comment"># the number of slabs to use for the RRset cache.</span>
    <span class="token key atrule">rrset-cache-slabs</span><span class="token punctuation">:</span> <span class="token number">4</span>
    
    <span class="token comment"># the number of slabs to use for the message cache.</span>
    <span class="token key atrule">msg-cache-slabs</span><span class="token punctuation">:</span> <span class="token number">4</span></code><!----></pre> <p>Now we can install AdGuard Home:</p> <pre class="language-shell"><!----><code class="language-shell"><span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-S</span> <span class="token parameter variable">-L</span> https://raw.githubusercontent.com/AdguardTeam/AdGuardHome/master/scripts/install.sh <span class="token operator">|</span> <span class="token function">sh</span> <span class="token parameter variable">-s</span> -- <span class="token parameter variable">-v</span>
/opt/AdGuardHome/AdGuardHome <span class="token parameter variable">-s</span> <span class="token function">install</span>
/opt/AdGuardHome/AdGuardHome <span class="token parameter variable">-s</span> start</code><!----></pre> <p>Now you can access to AdGuardHome web interface on port <code>3000</code>, set up AdGuardHome and set unbound at 127.0.0.1:5335 as upstream DNS server.</p> <p>Finally, set up your router to use the Raspberry PI 4 as DNS server for your network.</p> <p>Remember that if you wanna use Nextcloud you <strong>must</strong> set up DNS rewrite from <code>yourdomain.com</code> to your VPS DNS interface IP address in AdGuardHome, otherwise Nextcloud AIO will not work.</p> <p>To use Raspberry PI 4 as DNS resolver for clients connected to the VPN, you have to change the DNS server in the Wireguard config file under the DNS variable by putting the Raspberry PI VPN interface IP(generate another Wireguard config in the VPS if necessary by running <code>./wireguard-install.sh</code>).</p> <h2>Conclusion</h2> <p>Self-hosting is not for everyone, it requires time and patience to set up and maintain the services, but it gives you freedom and control over your data. If you are willing to spend some time to learn and manage your own services, I highly recommend you to try self-hosting.</p> <p>This article is not exhaustive, there are many other things to consider like backup, security, … but I hope it can be a good starting point for your self-hosting journey. In the future I will write more articles about my backup strategy and how to improve Jellyfin with <a href="https://github.com/NeptuneHub/AudioMuse-AI" rel="nofollow">AudioMuse-AI</a></p><!----></article></main></div><!----><!----><!----><!--]--> <!--[!--><!--]--><!--]-->
			
			<script>
				{
					__sveltekit_e9u4ja = {
						base: new URL(".", location).pathname.slice(0, -1),
						assets: "/personal_blog"
					};

					const element = document.currentScript.parentElement;

					Promise.all([
						import("./_app/immutable/entry/start.kbsSaK3P.js"),
						import("./_app/immutable/entry/app.CUdaUfCF.js")
					]).then(([kit, app]) => {
						kit.start(app, element, {
							node_ids: [0, 3],
							data: [null,null],
							form: null,
							error: null
						});
					});
				}
			</script>
		</div>
	</body>
</html>
